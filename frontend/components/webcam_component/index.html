<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 600px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        #video {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            background: #000;
            object-fit: cover;
            display: block;
        }

        .instruction {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 15px 0;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: #6b7280;
        }

        .debug {
            margin-top: 10px;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 12px;
            color: #92400e;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <video id="video" autoplay playsinline muted></video>
        <div id="instruction" class="instruction">ƒêang t·∫£i camera...</div>
        <div id="status" class="status">Vui l√≤ng ch·ªù...</div>
        <div id="debug" class="debug">ƒêang kh·ªüi t·∫°o...</div>
    </div>

    <script>
        const video = document.getElementById("video");
        const instructionEl = document.getElementById("instruction");
        const statusEl = document.getElementById("status");
        const debugEl = document.getElementById("debug");

        let capturing = false;
        let streamlitReady = false;

        const POSES = ["Nh√¨n th·∫≥ng", "Quay tr√°i", "Quay ph·∫£i", "Ng·∫©ng l√™n", "C√∫i xu·ªëng"];

        function log(msg) {
            console.log(msg);
            debugEl.textContent = msg;
        }

        function sendToStreamlit(data) {
            window.parent.postMessage({
                isStreamlitMessage: true,
                type: "streamlit:setComponentValue",
                value: data
            }, "*");
        }

        function setComponentReady() {
            log("‚úÖ Sending componentReady");
            window.parent.postMessage({
                isStreamlitMessage: true, type: "streamlit:componentReady", apiVersion: 1
            }, "*");
            window.parent.postMessage({
                isStreamlitMessage: true, type: "streamlit:setFrameHeight", height: 650
            }, "*");
            streamlitReady = true;
        }

        // ===== CAMERA =====
        navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" }
        }).then(stream => {
            log("‚úÖ Camera granted");
            video.srcObject = stream;
            instructionEl.textContent = 'S·∫µn s√†ng...';
            statusEl.textContent = "‚úÖ Camera OK. Ch·ªù l·ªánh t·ª´ server...";
            statusEl.style.background = "#d1fae5";
            setComponentReady();
        }).catch(err => {
            log("‚ùå Camera error: " + err.message);
            statusEl.textContent = "L·ªói Camera: " + err.message;
        });

        // ===== CAPTURE LOGIC =====
        async function startCapture() {
            if (capturing) return;
            capturing = true;
            log("üöÄ Start capture sequence");

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            for (let i = 0; i < 25; i++) {
                // Check l·∫°i n·∫øu video b·ªã m·∫•t k·∫øt n·ªëi
                if (video.readyState !== 4) {
                    await new Promise(r => setTimeout(r, 100));
                }

                const poseIdx = Math.floor(i / 5);
                const pose = POSES[poseIdx];

                instructionEl.textContent = `üì∏ ${pose}`;
                statusEl.textContent = `ƒêang ch·ª•p ${i + 1}/25...`;

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                // Gi·∫£m ch·∫•t l∆∞·ª£ng xu·ªëng 0.8 ƒë·ªÉ g·ª≠i nhanh h∆°n qua Cloudflare
                const imageData = canvas.toDataURL("image/jpeg", 0.80);

                sendToStreamlit({
                    image: imageData,
                    index: i + 1,
                    pose: pose
                });

                // TƒÉng delay l√™n 600ms ƒë·ªÉ Streamlit k·ªãp x·ª≠ l√Ω
                await new Promise(r => setTimeout(r, 600));
            }

            instructionEl.textContent = "‚úÖ ƒêang ho√†n t·∫•t...";
            statusEl.textContent = "ƒêang g·ª≠i d·ªØ li·ªáu cu·ªëi c√πng...";

            // --- QUAN TR·ªåNG: Ch·ªù 1.5 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o ·∫£nh 25 ƒë√£ ƒë∆∞·ª£c Python nh·∫≠n ---
            await new Promise(r => setTimeout(r, 1500));

            log("‚úÖ Capture sequence finished");
            capturing = false;

            sendToStreamlit({
                status: "done",
                total: 25
            });
        }

        // ===== LISTEN =====
        window.addEventListener("message", (event) => {
            if (event.data && event.data.type === "streamlit:render") {
                const args = event.data.args;
                if (args && args.start_capture === true && !capturing && streamlitReady) {
                    setTimeout(startCapture, 1000);
                }
            }
        });
    </script>
</body>

</html>