<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 600px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        #video {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            background: #000;
            object-fit: cover;
            display: block;
        }

        .instruction {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 15px 0;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: #6b7280;
        }

        .debug {
            margin-top: 10px;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 12px;
            color: #92400e;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <video id="video" autoplay playsinline muted></video>
        <div id="instruction" class="instruction">Äang táº£i camera...</div>
        <div id="status" class="status">Vui lÃ²ng chá»...</div>
        <div id="debug" class="debug">Äang khá»Ÿi táº¡o...</div>
    </div>

    <script>
        const video = document.getElementById("video");
        const instructionEl = document.getElementById("instruction");
        const statusEl = document.getElementById("status");
        const debugEl = document.getElementById("debug");

        let capturing = false;
        let streamlitReady = false;

        const POSES = [
            "NhÃ¬n tháº³ng",
            "Quay trÃ¡i",
            "Quay pháº£i",
            "Ngáº©ng lÃªn",
            "CÃºi xuá»‘ng"
        ];

        // Debug log
        function log(msg) {
            console.log(msg);
            debugEl.textContent = msg;
        }

        log("ğŸ”¥ Script loaded");

        // ===== STREAMLIT API =====
        function sendToStreamlit(data) {
            window.parent.postMessage({
                isStreamlitMessage: true,
                type: "streamlit:setComponentValue",
                value: data
            }, "*");
        }

        function setComponentReady() {
            log("âœ… Sending componentReady");

            window.parent.postMessage({
                isStreamlitMessage: true,
                type: "streamlit:componentReady",
                apiVersion: 1
            }, "*");

            window.parent.postMessage({
                isStreamlitMessage: true,
                type: "streamlit:setFrameHeight",
                height: 600
            }, "*");

            streamlitReady = true;
        }

        // ===== CAMERA =====
        log("ğŸ¥ Requesting camera...");

        navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user"
            }
        })
            .then(stream => {
                log("âœ… Camera granted");
                video.srcObject = stream;

                instructionEl.textContent = 'Nháº¥n "Báº¯t Ä‘áº§u chá»¥p"';
                statusEl.textContent = "âœ… Camera sáºµn sÃ ng";
                statusEl.style.background = "#d1fae5";
                statusEl.style.color = "#065f46";

                setComponentReady();
            })
            .catch(err => {
                log("âŒ Camera error: " + err.message);

                instructionEl.textContent = "âŒ KhÃ´ng truy cáº­p Ä‘Æ°á»£c camera";
                statusEl.textContent = err.message;
                statusEl.style.background = "#fee2e2";
                statusEl.style.color = "#991b1b";

                setComponentReady();
            });

        // ===== CAPTURE =====
        async function startCapture() {
            if (capturing) {
                log("âš ï¸ Already capturing");
                return;
            }

            capturing = true;
            log("ğŸš€ Start capture");

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            for (let i = 0; i < 25; i++) {
                const poseIdx = Math.floor(i / 5);
                const pose = POSES[poseIdx];

                instructionEl.textContent = `ğŸ“¸ ${pose}`;
                statusEl.textContent = `Äang chá»¥p ${i + 1}/25...`;
                log(`ğŸ“¸ Capturing ${i + 1}/25`);

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL("image/jpeg", 0.90);

                sendToStreamlit({
                    image: imageData,
                    index: i + 1,
                    pose: pose
                });

                await new Promise(r => setTimeout(r, 500)); // â† TÄƒng tá»« 400ms lÃªn 500ms
            }

            instructionEl.textContent = "âœ… HoÃ n táº¥t!";
            statusEl.textContent = "ÄÃ£ chá»¥p xong 25 áº£nh";
            statusEl.style.background = "#dbeafe";
            log("âœ… Capture done");

            capturing = false;

            sendToStreamlit({
                status: "done",
                total: 25
            });
        }

        // ===== LISTEN TO STREAMLIT =====
        window.addEventListener("message", (event) => {
            if (event.data && event.data.type === "streamlit:render") {
                const args = event.data.args;
                log(`ğŸ“© Received: start_capture=${args?.start_capture}`);

                if (args && args.start_capture === true && !capturing && streamlitReady) {
                    log("ğŸš€ Triggering capture in 1s...");
                    setTimeout(startCapture, 1000); // â† Delay 1s Ä‘á»ƒ Ä‘áº£m báº£o
                }
            }
        });

        log("âœ… Event listener ready");
    </script>
</body>

</html>